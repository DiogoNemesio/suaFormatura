<form id="zgFormGeraBoletoID" class="form-horizontal" method="post" action="%URL_MIDIA%" target="_blank">
<div class="modal-header">
	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
	<h4 class=""><i class="fa fa-check red"></i>&nbsp;%TITULO%</h4>
</div>
<div class="modal-body" style="overflow-y: scroll; height: 440px;">
	<input type="hidden" name="id" value="%ID%">
	<input type="hidden" name="tipoMidia" id="tipoMidiaID">
	<div class="row">
		<table id="cargoAltTableFuncaoID" class="table table-condensed table-hover table-bordered bootstrap-datatable datatable display" style="width: 100%;">
			<thead>
				<tr class="warning">
					<th class="col-sm-1 center"><label class="position-relative"><input type="checkbox" id="geraBoletoCheckallID" name="geraBoletoCheckall" class="ace" value="all" /><span class="lbl"></span></label></th>
					<th class="col-sm-1 center">Parcela</th>
					<th class="col-sm-1 center">Vencimento</th>
					<th class="col-sm-1 center">Vencimento(Boleto)</th>
					<th class="col-sm-1 center">Atraso</th>
					<th class="col-sm-1 center">Valor Original</th>
					<th class="col-sm-1 center">Saldo Devedor</th>
					<th class="col-sm-1 center">Juros</th>
					<th class="col-sm-1 center">Mora</th>
					<th class="col-sm-1 center">Desconto</th>
				</tr>
			</thead>
			<tbody>
			%TAB_PARCELAS%
			</tbody>
		</table>
	</div>
	<div class="row">
		<div class="col-sm-12">
			<div class="form-group col-sm-12" id="divInstrucaoID">
				<label for="instrucaoID" class="col-sm-3 control-label">Instruções adicionais</label>
				<div class="input-group col-sm-8 pull-left">
					<span class="input-group-addon"><i class="ace-icon fa fa-question-circle" data-rel="popover" data-placement="top" data-trigger="hover" data-original-title="<i class='ace-icon fa fa-question-circle red'></i> Ajuda" data-content="Instruções adicionais para o boleto"></i></span>
					<input type="text" id="instrucaoID" name="instrucao" maxlength="60" class="width-100" placeholder="Instruções adicionais" autocomplete="off"/>
				</div>
			<div class="help-block col-sm-1 inline" id="divHelpInstrucaoID"></div>
			</div>
		</div>
	</div>
    
	<div class="row">
		<div class="col-sm-12">
			<div class="form-group col-sm-12" id="divEmailID">
				<label for="instrucaoID" class="col-sm-3 control-label">E-mail do destinatário</label>
				<div class="input-group col-sm-8 pull-left">
					<span class="input-group-addon"><i class="ace-icon fa fa-question-circle" data-rel="popover" data-placement="top" data-trigger="hover" data-original-title="<i class='ace-icon fa fa-question-circle red'></i> Ajuda" data-content="E-mail que receberá o boleto, para enviar para mais de um, digite os e-mails separados por vírgula"></i></span>
					<input type="text" id="emailID" name="email" maxlength="300" value="%EMAIL%" class="width-100" placeholder="Email" autocomplete="off"/>
				</div>
			<div class="help-block col-sm-1 inline" id="divHelpEmailID"></div>
			</div>
		</div>
	</div>
    
    <div id="divMsgCPPagID">
    </div>
</div>
<div class="modal-footer">
	<button type="button" class="btn btn-warning" id="geraBoletoEnviaEmailID">Enviar e-mail</button>
	<button type="button" class="btn btn-primary" id="geraBoletoGeraPDFID">Gerar PDF</button>
	<button type="button" data-dismiss="modal" class="btn" id="btnGeraBoletoFecharID">Fechar</button>
</div>
</form>


<script type="text/javascript" charset="%CHARSET%">

$('#geraBoletoEnviaEmailID').click(function() {
	var $email	= $('#emailID').val();
	
	if (!$email) {
		$('#divEmailID').addClass('has-error');
		$('#divHelpEmailID').html(zgCriaSpanErro('E-mail deve ser preenchido'));
		return false;
	}
	
	$('#tipoMidiaID').val('MAIL');
	$('#geraBoletoEnviaEmailID').html("Enviando e-mail, aguarde ...");
	$('#geraBoletoEnviaEmailID').attr("disabled","disabled");
	$('#geraBoletoGeraPDFID').attr("disabled","disabled");
	
	$('#zgFormGeraBoletoID').submit(function(e) {
		$.ajax({
			type:	"POST", 
			url:	"%URL_MIDIA%",
			data:	$('#zgFormGeraBoletoID').serialize(),
		}).done(function( data, textStatus, jqXHR) {
			$('#btnGeraBoletoFecharID').click();
			$.gritter.add({
				title: 'E-mail enviado com sucesso',
				text: 'O E-mail com o boleto foi enviado com sucesso para os destinatários informados.',
				class_name: 'gritter-info',
				time: '5000'
			});
			//zgMostraAviso("Fechar");
		}).fail(function( jqXHR, textStatus, errorThrown) {
			zgMostraAviso(null);
		});
		//
		return false; 
	});
	$('#zgFormGeraBoletoID').submit();
	e.preventDefault();
	return false; 
});

$('#geraBoletoGeraPDFID').click(function() {
	$('#zgDivModalID').modal('hide');
	
	$('#tipoMidiaID').val('PDF');
	$('#zgFormGeraBoletoID').submit();
	e.preventDefault();
	
	return false; 
});


$('[data-rel=tooltip]').tooltip();
$('[data-rel=popover]').popover({html:true});
$('[data-rel="select2"]').select2();
$('.datepicker').datepicker({
	"autoclose": true,
}).on('show', function() {
    var $input		= $(this);
    var modalZIndex = $input.closest('.modal').css('z-index');
    var zIndex		= 9000;
    if (modalZIndex) {
        zIndex = parseInt(modalZIndex) + 1;
    }
    $('.datepicker').css("z-index", zIndex);
});


$('[zg-data-toggle="mask"]').each(function( index ) {
	zgMask($( this ), $( this ).attr('zg-data-mask'));
});


$("#geraBoletoCheckallID").change(function(){
    if(this.checked){
		$("input[name='codContaSel[]']").each(function(){
			this.checked	= true;
		});
	}else{
		$("input[name='codContaSel[]']").each(function(){
			this.checked	= false;
		});
	}
});




function GeraBolAtualizaJurosMora($index) {
	
	var $vencOrig			= $('input[name="vencimentoOriginal['+$index+']"]').val();
	var $vencimento			= $('input[name="vencimento['+$index+']"]').val();
	var $juros				= $('input[name="valorJuros['+$index+']"]');
	var $mora				= $('input[name="valorMora['+$index+']"]');
	var $codConta			= $('input[name="codConta['+$index+']"]').val();
	var $zero				= 0;
	var opt = {
			symbol : "",
			decimal : ",",
			thousand: ".",
			precision : 2,
			format: "%s%v"
		};
	
	var $dia,$mes,$ano,$temp,$oDataRec,$oVenc;
	$zero	= accounting.formatMoney($zero, opt);
	
	/**
	 * Cria os objetos Date
	 */
	$temp		= $vencimento.split('/');
	$dia		= parseInt($temp[0]);
	$mes		= parseInt($temp[1]) - 1;
	$ano		= parseInt($temp[2]);

	$oVenc		= new Date($ano,$mes,$dia);

	$temp		= $vencOrig.split('/');
	$dia		= parseInt($temp[0]);
	$mes		= parseInt($temp[1]) - 1;
	$ano		= parseInt($temp[2]);

	$oVencOrig	= new Date($ano,$mes,$dia);
	
	if ($oVencOrig >= $oVenc) {
		
		$juros.val($zero);
		$mora.val($zero);
		
		$juros.prop('readonly', true);
		$mora.prop('readonly', true);

	}else{
		
		var $spUpdate	= $('#spUpdate_'+$index+'_ID');
		var $trUpdate	= $('#trGeraBol_'+$index+'_ID');
		
		$spUpdate.removeClass("hidden");
		$trUpdate.addClass("warning");
		
		$.ajax({
			url: "%ROOT_URL%/Fin/getJurosMoraContaReceber.dp.php",
			data:  { codConta: $codConta, dataRef: $vencimento},
			async: false,
			success: function(data) {
				var $_juros	= data["valorJuros"];
				var $_mora	= data["valorMora"];

				$_juros		= parseFloat($_juros);
				$_mora		= parseFloat($_mora);
				
				$_juros	= accounting.formatMoney($_juros, opt);
				$_mora	= accounting.formatMoney($_mora, opt);

				$juros.val($_juros);
				$mora.val($_mora);
				
				$juros.prop('readonly', false);
				$mora.prop('readonly', false);
		    },
			dataType: 'json'
		});
		
		$spUpdate.addClass("hidden");
		$trUpdate.removeClass("warning");
		
	}
	
	$juros.trigger('change');
	$juros.trigger('keyup');
	$mora.trigger('change');
	$mora.trigger('keyup');
	
	GeraBolAtualizaSaldoDevedor($index);
}



function GeraBolAtualizaSaldoDevedor($index) {
	
	var $juros				= $('input[name="valorJuros['+$index+']"]').val();
	var $mora				= $('input[name="valorMora['+$index+']"]').val();
	var $saldoDevedor		= $('input[name="saldoDevedor['+$index+']"]').val();
	var $saldoDevedorTotal	= $('input[name="saldoDevedorTotal['+$index+']"]');
	var $desconto			= $('input[name="valorDesconto['+$index+']"]').val();
	var	$_st;
	
	
	$_juros					= parseFloat($juros.replace(".", "").replace(",","."));
	$_mora					= parseFloat($mora.replace(".", "").replace(",","."));
	$_saldo					= parseFloat($saldoDevedor.replace(".", "").replace(",","."));
	$_desc					= parseFloat($desconto.replace(".", "").replace(",","."));
	
	if (isNaN($_juros))		$_juros			= 0;
	if (isNaN($_mora))		$_mora			= 0;
	if (isNaN($_saldo))		$_saldo			= 0;
	if (isNaN($_desc))		$_desc			= 0;

	$_st					= ($_juros + $_mora + $_saldo) - $_desc;

	var opt = {
		symbol : "",
		decimal : ",",
		thousand: ".",
		precision : 2,
		format: "%s%v"
	};

	$_st	= accounting.formatMoney($_st, opt);
	
	$saldoDevedorTotal.val($_st);

	/**
	 * Seleciona o registro editado
	 */
	var $_chk	= $('input[type=checkbox][name="codContaSel[]"][value="'+$index+'"]');
	$_chk.prop('checked', true);

}

</script>
