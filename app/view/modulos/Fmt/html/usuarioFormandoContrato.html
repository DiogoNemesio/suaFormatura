<form id="zgFormModalUsuFmtCntID" class="form-horizontal">
<input type="hidden" id="valPorFormandoID" value="%VAL_POR_FORMANDO%">
<input type="hidden" id="dataMaxID" value="%DATA_CONCLUSAO%">
<input type="hidden" id="maxParcelasID" value="%MAX_PARCELAS%">
<input type="hidden" name="id" value="%ID%">
<div id="content">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		<h4 class=""><i class="fa fa-file-text-o blue"></i>&nbsp;%TITULO%</h4>
	</div>
	<div class="modal-body" style="overflow-y: auto; height: 480px;">
		<div id="user-profile-3" class="row">
			<div class="col-sm-12">
				<div class="row">
			    	<div class="col-sm-6">
						<div class="form-group col-sm-12" id="divNumMesesID">
					    	<label class="col-sm-4 control-label" for="numMesesID">Parcelas</label>
			    			<div class="input-group col-sm-7 pull-left">
		    					<span tabindex="99001" class="input-group-addon"><i class="ace-icon fa fa-question-circle" data-rel="popover" data-placement="top" data-trigger="hover" data-original-title="<i class='ace-icon fa fa-question-circle red'></i> Ajuda" data-content="Informe o número de parcelas para o pagamento."></i></span>
				    			<input class="form-control" id="numMesesID" %READONLY% type="text" name="numMeses" placeholder="Número de parcelas" maxlength="4" value="%NUM_MESES%" autocomplete="off" onchange="calcularParcelasUsuFmtCnt();" zg-data-toggle="mask" zg-data-mask="numero">
					    	</div>
					    	<div class="col-sm-1 pull-left" id="divHelpNumMesesID"></div>
						</div>
						<div class="form-group col-sm-12" id="divDataVencID">
						    <label for="identID" class="col-sm-4 control-label">1&ordf; vencimento</label>
				    		<div class="input-group col-sm-7 pull-left">
			    				<span tabindex="99002" class="input-group-addon"><i class="ace-icon fa fa-question-circle" data-rel="popover" data-placement="top" data-trigger="hover" data-original-title="<i class='ace-icon fa fa-question-circle red'></i> Ajuda" data-content="Informe a data de vencimento da primeira mensalidade, as próximas mensalidades vão ser geradas no mesmo dia do mês subsequente."></i></span>
			    				<input class="form-control %RO_DATA%" %READONLY% id="dataVencID" type="text" name="dataVenc" maxlength="10" value="%DATA_VENC%" onchange="calcularParcelasUsuFmtCnt();" autocomplete="off" zg-data-toggle="mask" zg-data-mask="data">
						    </div>
						    <div class="col-sm-1 pull-left" id="divHelpDataVencID"></div>
						</div>
						<div class="form-group col-sm-12" id="divFormaPagID">
							<label class="col-sm-4 control-label">Forma de Pag.</label>
			    			<div class="input-group col-sm-7 pull-left">
			    				<span tabindex="99003" class="input-group-addon"><i class="ace-icon fa fa-question-circle" data-rel="popover" data-placement="top" data-trigger="hover" data-original-title="<i class='ace-icon fa fa-question-circle red'></i> Ajuda" data-content="Selecione a Forma de Pagamento"></i></span>
								<select class="select2 %READONLY%" style="width:100%;" id="codFormaPagID" name="codFormaPag" data-rel="select2">
								%FORMAS_PAG%
								</select>
						    </div>
							<div class="help-block col-sm-1 inline" id="divHelpFormaPagID"></div>
				    	</div>
				    </div>
				    <div class="col-sm-6">
						<div class="profile-user-info profile-user-info-striped">
							<div class="profile-info-row">
								<div class="profile-info-name"> Formando: </div>
								<div class="profile-info-value">
									<span class="editable">%NOME%</span>
								</div>
							</div>

							<div class="profile-info-row">
								<div class="profile-info-name"> Mensalidade: </div>
								<div class="profile-info-value">
									<span class="editable">%VAL_POR_FORMANDO_FMT%</span>
								</div>
							</div>
						
							<div class="profile-info-row">
								<div class="profile-info-name"> Máximo de: </div>
								<div class="profile-info-value">
									<span class="editable" id="spTextoNumMesesID">%TEXTO%</span>
								</div>
							</div>
						</div>
			    	</div>
			    </div>
			    <div class="row %TAB_HID%" id="divTableUsuFmtCntID">
				    <table id="UsuFmtCntTableValorID" class="paginated table table-condensed table-hover table-bordered bootstrap-datatable datatable display">
						<thead>
							<tr class="warning">
								<th class="col-sm-1 center" id="thInfoHelpTableParcelasUsuFmtCntID"></th>
								<th class="col-sm-2 center">Parcela</th>
								<th class="col-sm-2 center">Valor</th>
								<th class="col-sm-2 center">Data</th>
								
							</tr>
						</thead>
						<tbody>
						%TAB_PARCELAS%
						</tbody>
						<tfoot>
							<tr class="warning">
								<th class="col-sm-1 center"></th>
								<th class="col-sm-2 center" id="thInfoParcelaUsuFmtCntID">%NUM_MESES%</th>
								<th class="col-sm-2 center" id="thInfoValorTotalUsuFmtCntID">%TOTAL_PARCELAS_FMT%</th>
								<th class="col-sm-2 center"></th>
							</tr>
						</tfoot>
					</table>
				</div>
				<div class="row center">
					<ul class="pagination" id="pagerValoresUsuFmtCntID"></ul>
				</div>			    
			    
			</div>
		</div>
	</div>
	<div class="modal-footer">
		<div class="pull-left" style="width: 70%; text-align: left;" id='UsuEnvCondivMsgID'></div>
		<button type="button" class="btn btn-primary %HID_SUBMIT%" id="UsuFmtCntSubmitID"><i class="fa fa-check bigger-110"></i>Salvar</button>
		<button type="button" data-dismiss="modal" class="btn" id="UsuFmtCntCancelID" >Fechar</button>
	</div>
</div>
</form>


<script type="text/javascript" charset="%CHARSET%">

$('[zg-data-toggle="mask"]').each(function( index ) {
	zgMask($( this ), $( this ).attr('zg-data-mask'));
});

paginateTableValoresUsuFmtCnt();

$('[data-rel=tooltip]').tooltip();
$('[data-rel=popover]').popover({html:true});
$('[data-rel="select2"]').select2({allowClear: true});
$('.datepicker').datepicker({"autoclose": true});

/** Desabilitar os selects para a tela de View **/
$('[data-rel="select2"]').each(function( index ) {
	if ($(this).hasClass('readonly')) {
		$(this).select2("readonly", true);
	}
});


$('#UsuFmtCntSubmitID').on("click", function(e) {
	
	//Bloquear botão enquanto estiver salvando
	$('#UsuFmtCntSubmitID').html('Aguarde...  <i class="ace-icon fa fa-spinner fa-spin orange bigger-125"></i>');
	$('#UsuFmtCntSubmitID').attr("disabled","disabled");
	$('#UsuFmtCntCancelID').attr("disabled","disabled");
	
	var vOK 	= validaUsuarioContrato();
	
	if(vOK == false) 	{
		
		//Desbloquear botão quando terminar de salvar
		$('#UsuFmtCntSubmitID').html('<i class="fa fa-check bigger-110"></i> Salvar ');
		$('#UsuFmtCntSubmitID').attr("disabled",false);
		$('#UsuFmtCntCancelID').attr("disabled",false);
		
		$.gritter.add({
			title: 'Está faltando alguma coisa !!!',
			text: 'Corrija os campos marcados em vermelho',
			class_name: 'gritter-info gritter-error',
			time: '5000'
		});
		e.preventDefault();
		
		return false;
	}else{
		$('#zgFormModalUsuFmtCntID').submit();
	}
});

//Submit formulário
$('#zgFormModalUsuFmtCntID').submit(function() {
	
	//Bloquear botão enquanto estiver salvando
	$('#UsuFmtCntSubmitID').html('Aguarde...  <i class="ace-icon fa fa-spinner fa-spin orange bigger-125"></i>');
	$('#UsuFmtCntSubmitID').attr("disabled","disabled");
	$('#UsuFmtCntCancelID').attr("disabled","disabled");
	
	$.ajax({
		type:	"POST", 
		url:	"%DP_MODAL%",
		data:	$('#zgFormModalUsuFmtCntID').serialize(),
	}).done(function( data, textStatus, jqXHR) {
		if (checaRetornoOK(data) == true) {
			zgMostraMsg('UsuEnvCondivMsgID','Contrato salvo com sucesso!');
		}else{
			zgMostraErro('UsuEnvCondivMsgID',zgGetMsgRetorno(data));
			//zgLimpaModalAviso();
			//zgMostraAviso("Fechar");
		}
		
		//Desbloquear botão quando terminar de salvar
		$('#UsuFmtCntSubmitID').html('<i class="fa fa-check bigger-110"></i> Salvar ');
		$('#UsuFmtCntSubmitID').attr("disabled",false);
		$('#UsuFmtCntCancelID').attr("disabled",false);
		
		$('#zgDivModalID').on('hidden.bs.modal', function () {
			zgLoadUrl('%URL_VOLTAR%');
			zgLimpaModal();
			$('#zgDivModalID').off('hidden.bs.modal');
		});
		
	}).fail(function( jqXHR, textStatus, errorThrown) {
		zgMostraErro('zgDivModalID',errorThrown);
	});
	return false; 
});

function validaUsuarioContrato(){
	var vNumMeses		= $('#numMesesID').val();
	var vData			= $('#dataVencID').val();
	var vFormaPag		= $('#codFormaPagID').val();
	var vOK				= true;
	
	/** Número de meses **/
	if(!vNumMeses){	
		$('#divNumMesesID').addClass('has-error');
		$('#divHelpNumMesesID').html(zgCriaSpanErro('Selecione o número de parcelas para o contrato.'));
		vOK		= false;
	}else{
		$('#divNumMesesID').removeClass('has-error');
		$('#divHelpNumMesesID').html('&nbsp;');		
	}
	
	/** Primeiro vencimento **/
	if(!vData){	
		$('#divDataVencID').addClass('has-error');
		$('#divHelpDataVencID').html(zgCriaSpanErro('Selecione o número de parcelas para o contrato.'));
		vOK		= false;
	}else{
		$('#divDataVencID').removeClass('has-error');
		$('#divHelpDataVencID').html('&nbsp;');		
	}
	

	if (vOK == true) {
		return true ;
	}else{
		return false;
	}
}

function calcularParcelasUsuFmtCnt(){
	var $numMeses			= parseInt($('#numMesesID').val());
	var $dataVencimento		= $('#dataVencID').val();
	
	/** Calcular o número de meses máximo até a conclusão **/
	calculaNumMesesUsuFmtCnt();
	
	var	$maxParcelas		= parseInt($('#maxParcelasID').val());
	var $ok					= true;
	
	if ($numMeses > $maxParcelas) {
		$('#divNumMesesID').addClass('has-error');
		$('#divHelpNumMesesID').html(zgCriaSpanErro('Número de meses dever ser inferior a '+$maxParcelas));
		$ok				= false;
		deleteTableUsuFmtCnt();
	}else{
		$('#divNumMesesID').removeClass('has-error');
		$('#divHelpNumMesesID').html('&nbsp;');
	}		
		
	if ($numMeses && $dataVencimento && ($ok == true)){
		criaTabelaValoresUsuFmtCnt();
	}else{
		/** exclui a tabela**/
		deleteTableUsuFmtCnt();
	}
}


function criaTabelaValoresUsuFmtCnt() {
	var $table					= $('#UsuFmtCntTableValorID');
	var $tipoRecParc			= $('#codTipoRecID').val();
	var $codPeriodoRec			= 'M';
	var $intervaloRec			= 1;
	var $dataVenc				= $('#dataVencID').val();
	var $numMeses				= parseInt($('#numMesesID').val());
	var $parcelas;
	var $datas;

	
	var $valPorFormando			= zgConverteFloat($('#valPorFormandoID').val());
	var $valParcela				= zgConverteFloat(($valPorFormando / $numMeses).toFixed(2));
	var $_parc;

	var options = {
		symbol : "",
		decimal : ",",
		thousand: ".",
		precision : 2,
		format: "%s%v"
	};
		
	var optTotal = {
		symbol : "R$ ",
		decimal : ",",
		thousand: ".",
		precision : 2,
		format: "%s%v"
	};


	$parcelas		= $numMeses;	
	if ($parcelas <= 1) {
		$tipoRecParc	= "U";
	}else{
		$tipoRecParc	= "P";
	}
	
	/** Resgata as datas de vencimentos **/
	jQuery.ajax({
		url: "%ROOT_URL%/Fin/geraDatasVencimentoConta.dp.php",
		data: { dataVenc: $dataVenc, codPeriodoRec: $codPeriodoRec, intervaloRec: $intervaloRec, numParcelas: $parcelas},
		success: function(ret) {
			$datas	= JSON.parse(ret);
		},
		method: 'get',
		cache: false,
		async:false
	});

	/** Remove os dados atuais **/
	deleteTableUsuFmtCnt();
	
	/** Mostra o div da tabela **/
	$('#divTableUsuFmtCntID').removeClass("hidden");
	
	for ($i = 0; $i < $parcelas; $i++) {
		var $descParcela	= ($i+1) + " / " + $parcelas;
		
		if ($tipoRecParc == "U") {
			$_parc	= $valPorFormando;
		}else{
			if ($i == ($parcelas -1)) {
				$_parc	= zgConverteFloat($valPorFormando	- ($valParcela	* ($parcelas -1) ));
			}else{
				$_parc 	= $valParcela;
			}
		}
		
		var $_parcFmt	= accounting.formatMoney($_parc	,options);
		$('#UsuFmtCntTableValorID > tbody:last').append('<tr><td class="center" style="width: 20px;"><div class="inline" zg-type="zg-div-msg"></div></td><td class="center" style="width: 40px;">'+$descParcela+'</td><td style="width: 120px;"><input type="text" class="form-control input-sm" name="aValor[]" value="'+$_parcFmt+'" onchange="atualizaEValidaParcelasUsuFmtCnt();" maxlength="20" autocomplete="off" zg-data-toggle="mask" zg-data-mask="dinheiro" zg-data-mask-retira="0"></td><td style="width: 120px;"><input type="text" class="form-control input-sm datepicker" name="aData[]" value="'+$datas[$i].dataVenc+'" onchange="atualizaEValidaParcelasUsuFmtCnt();" maxlength="10" autocomplete="off" zg-data-toggle="mask" zg-data-mask="data"></td></tr>');		
		$('#UsuFmtCntTableValorID > tbody > tr:last [zg-data-toggle="mask"]').each(function( index ) {
			zgMask($( this ), $( this ).attr('zg-data-mask'));
			$( this ).trigger('keyup');
		});
		
		$('#UsuFmtCntTableValorID > tbody > tr:last .datepicker').each(function( index ) {
			$(this).datepicker({"autoclose": true});
		});
		
	}

	$('#thInfoValorTotalUsuFmtCntID').html(accounting.formatMoney($valPorFormando,optTotal));
	$('#thInfoParcelaUsuFmtCntID').html($parcelas);
	atualizaEValidaParcelasUsuFmtCnt();
	paginateTableValoresUsuFmtCnt();
}

function deleteTableUsuFmtCnt () {
	/** Remove os dados atuais **/
	$('#UsuFmtCntTableValorID > tbody').find('tr').remove();
	$('#thInfoParcelaUsuFmtCntID').html("&nbsp;");
	$('#thInfoValorTotalUsuFmtCntID').html("&nbsp;");
	$('#divTableUsuFmtCntID').addClass("hidden");
}

function paginateTableValoresUsuFmtCnt() {
	$('#pagerValoresUsuFmtCntID li').remove();

	$('table.paginated').each(function() {
	    var currentPage = 0;
	    var numPerPage 	= 5;
	    var $table = $(this);
	    $table.bind('repaginate', function() {
	        $table.find('tbody tr').hide().slice(currentPage * numPerPage, (currentPage + 1) * numPerPage).show();
	    });
	    $table.trigger('repaginate');
	    var numRows = $table.find('tbody tr').length;
	    var numPages = Math.ceil(numRows / numPerPage);
	    var $pager = $('#pagerValoresUsuFmtCntID');
	    for (var page = 0; page < numPages; page++) {
	    	$('<li><a href="#"><span class="page-number">'+(page + 1)+'</span></a></li>').bind('click', {
	        //$('<span class="page-number"></span>').text(page + 1).bind('click', {
	            newPage: page
	        }, function(event) {
	            currentPage = event.data['newPage'];
	            $table.trigger('repaginate');
	            $(this).addClass('active').siblings().removeClass('active');
	        }).appendTo($pager).addClass('clickable');
	    }
	    $pager.insertBefore($table).find('span.page-number:first').addClass('active');
	});
}

	
function atualizaEValidaParcelasUsuFmtCnt() {
	var $tValor					= parseFloat(0);
	var $htmlOK					= zgCriaSpanOK();
	var $htmlError1				= false;
	var $htmlError2				= false;
	var $vOK					= true;
	var $menorData;
	var $tipoRecParc;
	var $numMeses				= parseInt($('#numMesesID').val());
	var $parcelas;
	var $valPorFormando			= zgConverteFloat($('#valPorFormandoID').val());
	var $valParcela				= zgConverteFloat(($valPorFormando / $numMeses).toFixed(2));

	var opt = {
		symbol : "",
		decimal : ",",
		thousand: ".",
		precision : 2,
		format: "%s%v"
	};

	var opt1 = {
		symbol : "R$ ",
		decimal : ",",
		thousand: ".",
		precision : 2,
		format: "%s%v"
	};

	/** Calcula a soma dos valores, para verificar se bate com o total **/
	$('#UsuFmtCntTableValorID > tbody > tr').each(function( index ) {
		var $_valor;
		$(this).find('[name*="aValor[]"]').each(function( index2 ) {
			$_valor			 	= zgConverteFloat($(this).val());
			$tValor				+= $_valor;
		});
	});

	/** Ajusta os valores totais **/
	$tValor					= zgConverteFloat($tValor.toFixed(2));

	/** Calcula o tipo de recorrência através do número de parcelas **/
	if ($numMeses <= 1) {
		$tipoRecParc	= "U";
	}else{
		$tipoRecParc	= "P";
	}

	/** Valida os valores **/
	if ($valPorFormando != $tValor) {
		var $texto;
		var	$diff	= ($valPorFormando - $tValor);
		
		if ($diff > 0) {
			$texto		= "Falta ainda: "+accounting.formatMoney($diff, opt1);
		}else{
			$texto		= "Valor está a maior: "+accounting.formatMoney(($diff*-1), opt1);
		}
		
		$htmlError1	= zgCriaSpanErro($texto);
		$vOK		= false;
	}
	
	if ($htmlError1) {
		$('#thInfoValorTotalUsuFmtCntID').html($htmlError1);
	}else{
		$('#thInfoValorTotalUsuFmtCntID').html($htmlOK + "&nbsp;"+ accounting.formatMoney($valPorFormando, opt1));
	}
	
	/** Valida Data **/
	$('#UsuFmtCntTableValorID > tbody > tr [name*="aData[]"]').each(function( index ) {
		var $td		= $(this).parent();
		var $tr		= $td.parent();

		if (index == 0) {
			$menorData = moment($(this).val(), "%FORMATO_DATA%");
			$tr.find('[zg-type="zg-div-msg"]').html(zgCriaSpanOK());
		}else{
			var $data	= moment($(this).val(), "%FORMATO_DATA%");
			var $dif	= $data - $menorData; 
			
			if ($dif < 0) {
				$tr.find('[zg-type="zg-div-msg"]').html(zgCriaSpanErro("Data deve ser maior do que a parcela anterior"));
				$tr.addClass("alert-danger");
				$vOK		= false;
				$htmlError2	= zgCriaSpanErro("Verifique as datas dos registros marcados");
			}else{
				$tr.find('[zg-type="zg-div-msg"]').html(zgCriaSpanOK());
				$tr.removeClass("alert-danger");
			}
			$menorData = moment($(this).val(), "%FORMATO_DATA%");
		}
	});

	
	if ($htmlError2) {
		$('#thInfoHelpTableParcelasUsuFmtCntID').html($htmlError2);
	}else{
		$('#thInfoHelpTableParcelasUsuFmtCntID').html(zgCriaSpanOK());
	}

	return $vOK;
	
}


function calculaNumMesesUsuFmtCnt() {
	var $dataMax			= $('#dataMaxID').val();
	var $dataVencimento		= $('#dataVencID').val();
	var $meses				= parseInt(calculaNumMesesEntreDatas($dataVencimento,$dataMax));
	var $texto;
	
	if ($meses < 0) {
		$meses 	= 0;
	}
	if ($meses == 1) {
		$texto			= $meses+" mês";
	}else{
		$texto			= $meses+" meses";
	}
	
	$texto			+= " ("+$dataMax+")";

	$('#spTextoNumMesesID').html($texto);
	$('#maxParcelasID').val($meses);

}

</script>

