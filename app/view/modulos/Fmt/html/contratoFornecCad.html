<form id="zgFormModalConForCadID" class="form-horizontal">
<input type="hidden" id="qtdeMaxID" value="%QTDE_EVENTO%">
<input type="hidden" id="qtdeContratadaAtualID" value="%QTDE_CONTRATADA%">
<input type="hidden" name="id" value="%ID%">
<input type="hidden" name="codItem" value="%COD_ITEM%">
<div id="content">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		<h4 class=""><i class="fa fa-file-text-o blue"></i>&nbsp;%TITULO%
		</h4>
	</div>
	<div class="modal-body" style="overflow-y: auto; height: 480px;">
		<div class="row">
			<div class="col-sm-12">
				<div class="row">
			    	<div class="col-sm-8">
						<div class="form-group col-sm-12" id="divQtdeID">
					    	<label class="col-sm-4 control-label" for="qtdeID">Qtde a contratar</label>
			    			<div class="input-group col-sm-7 pull-left">
		    					<span tabindex="99001" class="input-group-addon"><i class="ace-icon fa fa-question-circle" data-rel="popover" data-placement="top" data-trigger="hover" data-original-title="<i class='ace-icon fa fa-question-circle red'></i> Ajuda" data-content="Quantidade que será contratada do fornecedor"></i></span>
				    			<input class="form-control" id="qtdeID" type="text" name="qtde" placeholder="Quantidade a contratar" maxlength="6" autocomplete="off" onchange="validaQuantidadeConForCad();" zg-data-toggle="mask" zg-data-mask="numero">
					    	</div>
					    	<div class="col-sm-1 pull-left" id="divHelpQtdeID"></div>
						</div>
						<div class="form-group col-sm-12" id="divFornecedorID">
							<label class="col-sm-4 control-label">Fornecedor</label>
			    			<div class="input-group col-sm-7 pull-left">
			    				<span tabindex="99003" class="input-group-addon"><i class="ace-icon fa fa-question-circle" data-rel="popover" data-placement="top" data-trigger="hover" data-original-title="<i class='ace-icon fa fa-question-circle red'></i> Ajuda" data-content="Selecione o fornecedor a ser contradado"></i></span>
								<select class="select2" style="width:100%;" id="codFornecedorID" name="codFornecedor" data-rel="select2">
								%FORNECEDORES%
								</select>
						    </div>
							<div class="help-block col-sm-1 inline" id="divHelpFornecedorID"></div>
				    	</div>
						<div class="form-group col-sm-12" id="divButtonID">
							<label class="col-sm-4 control-label">
								<span class="" onclick="addRowConForCad();"><i class="fa fa-plus-circle blue bigger-150"></i></span>
							</label>
				    	</div>
				    </div>
				    <div class="col-sm-4">
						<div class="profile-user-info profile-user-info-striped">
							<div class="profile-info-row">
								<div class="profile-info-name">Qtde do evento: </div>
								<div class="profile-info-value">
									<span class="editable">%QTDE_EVENTO%</span>
								</div>
							</div>
							<div class="profile-info-row">
								<div class="profile-info-name">Falta: </div>
								<div class="profile-info-value">
									<span class="editable" id="spQtdeFaltaID">%QTDE_FALTA%</span>
								</div>
							</div>
						</div>
			    	</div>
			    </div>
			    <div class="row %TAB_HID%" id="divTableConForCadID">
				    <table id="ConForCadTableContratosID" class="paginated table table-condensed table-hover table-bordered bootstrap-datatable datatable display">
						<thead>
							<tr class="warning">
								<th class="col-sm-2 center">Quantidade</th>
								<th class="col-sm-2 center">Fornecedor</th>
								<th class="col-sm-2 center">Data do contrato</th>
								<th class="col-sm-1 center"></th>
							</tr>
						</thead>
						<tbody>
						%TAB_ITENS%
						</tbody>
						<tfoot>
							<tr class="warning">
								<th class="col-sm-2 center" id="thInfoQtdeConForCadID">%QTDE_CONTRATADA%</th>
								<th class="col-sm-2 center"></th>
								<th class="col-sm-2 center"></th>
								<th class="col-sm-1 center"></th>
							</tr>
						</tfoot>
					</table>
				</div>
				<div class="row center">
					<ul class="pagination" id="pagerValoresConForCadID"></ul>
				</div>
			</div>	
	    </div>
	</div>
	<div class="modal-footer">
		<div class="pull-left" style="width: 70%; text-align: left;" id='ConForCaddivMsgID'></div>
		<button type="button" class="btn btn-primary %HID_SUBMIT%" id="ConForCadSubmitID"><i class="fa fa-check bigger-110"></i>Salvar</button>
		<button type="button" data-dismiss="modal" class="btn" id="ConForCadCancelID" >Fechar</button>
	</div>
</div>
</form>


<script type="text/javascript" charset="%CHARSET%">

$('[zg-data-toggle="mask"]').each(function( index ) {
	zgMask($( this ), $( this ).attr('zg-data-mask'));
});

paginateTableValoresConForCad();

$('[data-rel=tooltip]').tooltip();
$('[data-rel=popover]').popover({html:true});
$('[data-rel="select2"]').select2({allowClear: true});
$('.datepicker').datepicker({"autoclose": true});

/** Desabilitar os selects para a tela de View **/
$('[data-rel="select2"]').each(function( index ) {
	if ($(this).hasClass('readonly')) {
		$(this).select2("readonly", true);
	}
});

$('#ConForCadSubmitID').on("click", function(e) {
	
	//Bloquear botão enquanto estiver salvando
	$('#ConForCadSubmitID').html('Aguarde...  <i class="ace-icon fa fa-spinner fa-spin orange bigger-125"></i>');
	$('#ConForCadSubmitID').attr("disabled","disabled");
	$('#ConForCadCancelID').attr("disabled","disabled");
	
	var vOK 	= validaUsuarioContrato();
	
	if(vOK == false) 	{
		
		//Desbloquear botão quando terminar de salvar
		$('#ConForCadSubmitID').html('<i class="fa fa-check bigger-110"></i> Salvar ');
		$('#ConForCadSubmitID').attr("disabled",false);
		$('#ConForCadCancelID').attr("disabled",false);
		
		$.gritter.add({
			title: 'Está faltando alguma coisa !!!',
			text: 'Corrija os campos marcados em vermelho',
			class_name: 'gritter-info gritter-error',
			time: '5000'
		});
		e.preventDefault();
		
		return false;
	}else{
		$('#zgFormModalConForCadID').submit();
	}
});

//Submit formulário
$('#zgFormModalConForCadID').submit(function() {
	
	//Bloquear botão enquanto estiver salvando
	$('#ConForCadSubmitID').html('Aguarde...  <i class="ace-icon fa fa-spinner fa-spin orange bigger-125"></i>');
	$('#ConForCadSubmitID').attr("disabled","disabled");
	$('#ConForCadCancelID').attr("disabled","disabled");
	
	
	var $aSelEventos	= [];
	$('input[name="codEventoSel[]"]:checked').each( function() {
		var $codEvento						= $(this).val();
		$aSelEventos[$aSelEventos.length]	= $codEvento;
	});

	$("#aSelEventosID").val($aSelEventos);
	
	$.ajax({
		type:	"POST", 
		url:	"%DP_MODAL%",
		data:	$('#zgFormModalConForCadID').serialize(),
	}).done(function( data, textStatus, jqXHR) {
		if (checaRetornoOK(data) == true) {
			zgMostraMsg('UsuEnvCondivMsgID','Contrato salvo com sucesso!');
		}else{
			zgMostraErro('UsuEnvCondivMsgID',zgGetMsgRetorno(data));
			//zgLimpaModalAviso();
			//zgMostraAviso("Fechar");
		}
		
		//Desbloquear botão quando terminar de salvar
		$('#ConForCadSubmitID').html('<i class="fa fa-check bigger-110"></i> Salvar ');
		$('#ConForCadSubmitID').attr("disabled",false);
		$('#ConForCadCancelID').attr("disabled",false);
		
		$('#zgDivModalID').on('hidden.bs.modal', function () {
			zgLoadUrl('%URL_VOLTAR%');
			zgLimpaModal();
			$('#zgDivModalID').off('hidden.bs.modal');
		});
		
	}).fail(function( jqXHR, textStatus, errorThrown) {
		zgMostraErro('zgDivModalID',errorThrown);
	});
	return false; 
});

function validaConForCad(){
	var $ok;

	$ok		= validaQuantidadeConForCad();
	if (!$ok)	return false;

	$ok		= validaFornecedorConForCad();
	return $ok;
}

function calculaQuantidadeAtualConForCad() {
	var $oQtdeAtual				= $('#qtdeContratadaAtualID');
	var $qtdeMax				= parseInt($('#qtdeMaxID').val());
	var $qtdeAtual				= 0;
	
	/** Calcula a soma dos valores, para verificar se bate com o total **/
	$('#ConForCadTableContratosID > tbody > tr').each(function( index ) {
		var $_qtde;
		$(this).find('[name*="aQtde[]"]').each(function( index2 ) {
			$_qtde			 	= zgConverteFloat($(this).val());
			$qtdeAtual			+= $_qtde;
		});
	});

	/** Ajusta os valores totais **/
	$qtdeAtual					= zgConverteFloat($qtdeAtual);
	$oQtdeAtual.val($qtdeAtual);
	
	/** Atualiza a quantidade faltante **/
	var $falta			= $qtdeMax - $qtdeAtual;
	$('#spQtdeFaltaID').html($falta);
	
}

function validaQuantidadeConForCad(){

	/** Calcular a quantidade atual **/
	calculaQuantidadeAtualConForCad();

	var $qtde				= parseInt($('#qtdeID').val());
	var $qtdeMax			= parseInt($('#qtdeMaxID').val());
	var $qtdeAtual			= parseInt($('#qtdeContratadaAtualID').val());
	var $qtdeDisp			= ($qtdeMax - $qtdeAtual);
	var $textoDisp;
	
	if ($qtdeDisp > 1)	{
		$textoDisp	= "existem apenas "+$qtdeDisp+" disponíveis";
	}else{
		$textoDisp	= "existe apenas "+$qtdeDisp+" disponível";
	}
	var $ok					= true;
	
	if ($qtde > $qtdeDisp) {
		$('#divQtdeID').addClass('has-error');
		$('#divHelpQtdeID').html(zgCriaSpanErro('Quantidade indisponível para contratação, '+$textoDisp,"bottom"));
		$ok				= false;
	}else{
		$('#divQtdeID').removeClass('has-error');
		$('#divHelpQtdeID').html('&nbsp;');
	}
	
	return $ok;
	
}


function validaFornecedorConForCad(){
	var $fornecedor		= $('#codFornecedorID').val();
	var $ok				= true;

	if (!$fornecedor) {
		$('#divFornecedorID').addClass('has-error');
		$('#divHelpFornecedorID').html(zgCriaSpanErro('Fornecedor deve ser selecionado',"bottom"));
		$ok				= false;
	}else{
		$('#divFornecedorID').removeClass('has-error');
		$('#divHelpFornecedorID').html('&nbsp;');
	}
	
	return $ok;
}


function addRowConForCad() {
	
	var $table				= $('#ConForCadTableContratosID');
	var $qtde				= parseInt($('#qtdeID').val());
	var $codFornecedor		= $('#codFornecedorID').val();
	var $fornecedor			= $("#codFornecedorID option:selected").text();
	var $hoje				= moment().format("%FORMATO_DATA%");;
	
	if (!validaConForCad()) {
		return false;
	}

	/** Mostra o div da tabela **/
	$('#divTableConForCadID').removeClass("hidden");
	
	$('#ConForCadTableContratosID > tbody:last').append('<tr><td class="center">'+$qtde+'<input type="hidden" name="aQtde[]" value="'+$qtde+'"></td><td class="">'+$fornecedor+'<input type="hidden" name="aCodPessoa[]" value="'+$codFornecedor+'"></td><td class="center">'+$hoje+'<input type="hidden" name="aData[]" value="'+$hoje+'"></td><td class="center"><span class="center" zgdelete onclick="delRowConForCad($(this));"><i class="fa fa-trash bigger-150 red"></i></span><input type="hidden" name="codItem[]"></td></tr>');
	
	/** Recalcula a quantidade total **/
	calculaQuantidadeAtualConForCad();
	var $qtdeAtual			= parseInt($('#qtdeContratadaAtualID').val());
	
	$('#thInfoQtdeConForCadID').html($qtdeAtual);
	paginateTableValoresConForCad();
	
	/** Atualiza o campo da quantidade para o saldo restante **/
	var $qtdeAtual			= parseInt($('#qtdeContratadaAtualID').val());
	var $qtdeMax			= parseInt($('#qtdeMaxID').val());
	var $falta				= $qtdeMax - $qtdeAtual;
	$('#qtdeID').val($falta);
	
}

function delRowConForCad(pObj) {
	var $td		= pObj.parent();
	var $tr		= $td.parent();
	$tr.addClass("danger");
	$tr.fadeOut(800, function(){
		$tr.remove();

		/** Recalcula a quantidade total **/
		calculaQuantidadeAtualConForCad();
		var $qtdeAtual			= parseInt($('#qtdeContratadaAtualID').val());
		
		$('#thInfoQtdeConForCadID').html($qtdeAtual);
		paginateTableValoresConForCad();
	});
	

}


function deleteTableConForCad () {
	/** Remove os dados atuais **/
	$('#ConForCadTableContratosID > tbody').find('tr').remove();
	$('#thInfoQtdeConForCadID').html("&nbsp;");
	$('#divTableConForCadID').addClass("hidden");
}

function paginateTableValoresConForCad() {
	$('#pagerValoresConForCadID li').remove();

	$('table.paginated').each(function() {
	    var currentPage = 0;
	    var numPerPage 	= 5;
	    var $table = $(this);
	    $table.bind('repaginate', function() {
	        $table.find('tbody tr').hide().slice(currentPage * numPerPage, (currentPage + 1) * numPerPage).show();
	    });
	    $table.trigger('repaginate');
	    var numRows = $table.find('tbody tr').length;
	    var numPages = Math.ceil(numRows / numPerPage);
	    var $pager = $('#pagerValoresConForCadID');
	    for (var page = 0; page < numPages; page++) {
	    	$('<li><a href="#"><span class="page-number">'+(page + 1)+'</span></a></li>').bind('click', {
	        //$('<span class="page-number"></span>').text(page + 1).bind('click', {
	            newPage: page
	        }, function(event) {
	            currentPage = event.data['newPage'];
	            $table.trigger('repaginate');
	            $(this).addClass('active').siblings().removeClass('active');
	        }).appendTo($pager).addClass('clickable');
	    }
	    $pager.insertBefore($table).find('span.page-number:first').addClass('active');
	});
}
	
</script>

