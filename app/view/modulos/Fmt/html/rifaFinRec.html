<form id="zgFormModalID" class="form-horizontal">
<input type="hidden" name="codUsuario" value="%COD_USUARIO%">
<input type="hidden" name="codOrganizacao" value="%COD_ORGANIZACAO%">
<input type="hidden" name="id" value="%ID%">
<input type="hidden" name="codRifa" id="codRifaID" value="%COD_RIFA%">
<input type="hidden" id="nomeID" value="%NOME_RIFA%">
<input type="hidden" id="valorUnitarioID" value="%VALOR_RIFA%">
<input type="hidden" id="qtdeObrigatorioID" value="%QTDE_OBRI%">
<input type="hidden" id="indEletronicaID" value="%IND_ELETRONICA%">
<input type="hidden" name="qtdeGerada" id="qtdeGeradaID" value="%QTDE_GERADA%">
<input type="hidden" id="formandoID" value="%NOME_FORMANDO%">
<input type="hidden" name="valorTotal" id="valorTotalID" value="%VALOR_TOTAL%">
<input type="hidden" name="valorPago" id="valorPagoID" value="%VALOR_PAGO%">
<input type="hidden" name="valorReceber" id="valorReceberID" value="%MAX_VALOR%">

<div id="content">
	<div class="modal-header">
		<button type="button" class="close" onclick='zgLimpaModal()' data-dismiss="modal" aria-hidden="true">×</button>
		<h4 class=""><i class="fa fa-money green"></i>&nbsp;%TITULO%</h4>
	</div>
	<div class="modal-body" style="height: 420px;">
		<div id='rifaFinRecMsgID'>
		</div>
		
		<div class="col-sm-12">
			<div class="row">
  					<div class="col-xs-12 col-sm-12">
    			<div class="widget-body">
					<div class="widget-main">
						<p>
						%TEXTO%
						</p>
					</div>
				</div>
 						</div> 
  				</div>
			<div class="row">
				<div class="col-sm-7">
					<div class="widget-box transparent">
						<div class="widget-header widget-header-small">
							<h5 class="widget-title smaller">
							<i class="ace-icon fa fa-check-square-o bigger-110"></i>
								Receber
							</h5>
						</div>
					</div>
					<div class="form-group col-sm-12" id="divQtdeVendidaID">
				    	<label class="col-sm-4 control-label" for="qtdeVendidaID">Qtde de rifas vendidas</label>
		    			<div class="input-group col-sm-6 pull-left">
	    					<span class="input-group-addon"><i class="ace-icon fa fa-question-circle" data-rel="popover" data-placement="top" data-trigger="hover" data-original-title="<i class='ace-icon fa fa-question-circle red'></i> Ajuda" data-content="Informe o título da rifa."></i></span>
			    			<input class="form-control" id="qtdeVendidaID" %READONLY% type="text" name="qtdeVendida" placeholder="Quantidade de rifas a pagar" maxlength="100" value="%QTDE_VENDIDA%" onchange="atualizaResumo()" autocomplete="off" zg-data-toggle="mask" zg-data-mask="numero">
				    	</div>
				    	<div class="col-sm-1 pull-left" id="divHelpQtdePagarID"></div>
					</div>
					<div class="form-group col-sm-12" id="divValorRecebidoID">
				    	<label class="col-sm-4 control-label" for="valorRecebidoID">Valor a receber</label>
		    			<div class="input-group col-sm-6 pull-left">
	    					<span class="input-group-addon"><i class="ace-icon fa fa-question-circle" data-rel="popover" data-placement="top" data-trigger="hover" data-original-title="<i class='ace-icon fa fa-question-circle red'></i> Ajuda" data-content="Valor pago pelo formando."></i></span>
			    			<input class="form-control" id="valorRecebidoID" type="text" name="valorRecebido" placeholder="Valor (R$) a receber" maxlength="100" value="%VALOR_RECEBER%" onchange="atualizaResumo()" autocomplete="off" zg-data-toggle="mask" zg-data-mask="dinheiro">
				    	</div>
				    	<div class="col-sm-1 pull-left" id="divHelpalorRecebidoID"></div>
					</div>
					
					<div class="form-group col-sm-12" id="divFormaPagID">
						<label class="col-sm-4 control-label">Forma de Pag.</label>
		    			<div class="input-group col-sm-6 pull-left">
		    				<span tabindex="99011" class="input-group-addon"><i class="ace-icon fa fa-question-circle" data-rel="popover" data-placement="top" data-trigger="hover" data-original-title="<i class='ace-icon fa fa-question-circle red'></i> Ajuda" data-content="Selecione a Forma de Pagamento da Conta"></i></span>
							<select class="select2" style="width:100%;" id="codFormaPagID" name="codFormaPag" data-rel="select2">
							%FORMAS_PAG%
							</select>
					    </div>
						<div class="help-block col-sm-1 inline" id="divHelpFormaPagID"></div>
			    	</div>
			    	<div class="form-group col-sm-12" id="divContaRecID">
						<label class="col-sm-4 control-label">Conta de Recebimento</label>
		    			<div class="input-group col-sm-6 pull-left">
		    				<span tabindex="99012" class="input-group-addon"><i class="ace-icon fa fa-question-circle" data-rel="popover" data-placement="top" data-trigger="hover" data-original-title="<i class='ace-icon fa fa-question-circle red'></i> Ajuda" data-content="Conta de Recebimento (Conta que será creditado o valor)"></i></span>
							<select class="select2" style="width:100%;" id="codContaRecID" name="codContaRec" data-rel="select2">
							%CONTAS%
							</select>
					    </div>
						<div class="help-block col-sm-1 inline" id="divHelpContaRecID"></div>
			    	</div>
		    	</div>
		    	<div class="col-sm-5">
		    		<div class="widget-box transparent">
						<div class="widget-header widget-header-small">
							<h5 class="widget-title smaller">
							<i class="ace-icon fa fa-check-square-o bigger-110"></i>
								Resumo
							</h5>
						</div>
					</div>
					
					<div class="row" id="divInfoFormandoID">
						<div class="col-sm-12">
					    	<p class="col-sm-4 pull-left align-right text-info inline" style="padding: 2px; margin:0;">Formando:</p>
					    	<p id='lbInfoFormandoID' class="col-sm-8 pull-right align-left" style="padding: 2px; margin:0;"></p>
				    	</div>
					</div>
					<div class="row" id="divInfoNomeID">
						<div class="col-sm-12">
					    	<p class="col-sm-4 pull-left align-right text-info inline" style="padding: 2px; margin:0;">Nome:</p>
					    	<p id='lbInfoNomeID' class="col-sm-8 pull-right align-left" style="padding: 2px; margin:0;"></p>
				    	</div>
					</div>
					<div class="row" id="divInfoTipoID">
						<div class="col-sm-12">
					    	<p class="col-sm-4 pull-left align-right text-info inline" style="padding: 2px; margin:0;">Tipo:</p>
					    	<p id='lbInfoTipoID' class="col-sm-8 pull-right align-left" style="padding: 2px; margin:0;"></p>
				    	</div>
					</div>
					<div class="row" id="divInfoValorID">
						<div class="col-sm-12">
					    	<p class="col-sm-4 pull-left align-right text-info inline" style="padding: 2px; margin:0;">Valor da RIFA:</p>
					    	<p id='lbInfoValorID' class="col-sm-8 pull-right align-left" style="padding: 2px; margin:0;"></p>
				    	</div>
					</div>
					<div class="row" id="divInfoQtdeObrigatorioID">
						<div class="col-sm-12">
					    	<p class="col-sm-4 pull-left align-right text-info inline" style="padding: 2px; margin:0;">Qtde obrigatória:</p>
					    	<p id='lbInfoQtdeObrigatorioID' class="col-sm-8 pull-right align-left" style="padding: 2px; margin:0;"></p>
				    	</div>
					</div>
					<div class="row hidden" id="divInfoQtdeGeradaID">
						<div class="col-sm-12">
					    	<p class="col-sm-4 pull-left align-right text-info inline" style="padding: 2px; margin:0;">Qtde Gerada:</p>
					    	<p id='lbInfoQtdeGeradaID' class="col-sm-8 pull-right align-left" style="padding: 2px; margin:0;"></p>
				    	</div>
					</div>
					<div class="row" id="divInfoQtdeVendaID">
						<div class="col-sm-12">
					    	<p class="col-sm-4 pull-left align-right text-info inline" style="padding: 2px; margin:0;">Qtde vendida:</p>
					    	<p id='lbInfoQtdeVendaID' class="col-sm-8 pull-right align-left" style="padding: 2px; margin:0;"></p>
				    	</div>
					</div>
					<div class="row" id="divInfoTotalID">
						<div class="col-sm-12">
					    	<p class="col-sm-4 pull-left align-right text-info inline" style="padding: 2px; margin:0;"><b>TOTAL (R$):</b></p>
					    	<p id='lbInfoTotalID' class="col-sm-8 pull-right align-left" style="padding: 2px; margin:0;"></p>
				    	</div>
					</div>
					<div class="row" id="divInfoValorPagoID">
						<div class="col-sm-12">
					    	<p class="col-sm-4 pull-left align-right text-info inline" style="padding: 2px; margin:0;"><b>Já Pago (R$):</b></p>
					    	<p id='lbInfoValorPagoID' class="col-sm-8 pull-right align-left" style="padding: 2px; margin:0;"></p>
				    	</div>
					</div>
					<div class="row" id="divInfoDebitoID">
						<div class="col-sm-12">
					    	<p class="col-sm-4 pull-left align-right text-info inline" style="padding: 2px; margin:0;">DÉBITO (R$):</p>
					    	<p id='lbInfoDebitoID' class="col-sm-8 pull-right align-left" style="padding: 2px; margin:0;"></p>
				    	</div>
					</div>
			    </div>
		    </div>
		</div>
		
	</div>
	<div class="modal-footer">
		<button type="button" class="btn btn-success" %DISABLED% id="rifaFinRecSubmitID"><i class="fa fa-check bigger-110"></i>Confirmar</button>
		<button type="button" data-dismiss="modal" class="btn" id="rifaFinRecCancelID" >Fechar</button>
	</div>
</div>
</form>


<script type="text/javascript" charset="%CHARSET%">

//Popover
$('[data-rel=popover]').popover({html:true});
//Máscaras
$('[zg-data-toggle="mask"]').each(function( index ) {
	zgMask($( this ), $( this ).attr('zg-data-mask'));
});

//SELECT2
$('#codFormaPagID').css('width','100%').select2({allowClear:true});
$('#codContaRecID').css('width','100%').select2({allowClear:true});


//Atualizar MENU
atualizaResumo();

function atualizaResumo() {
	var $formando		= $('#formandoID').val();
	var $nome			= $('#nomeID').val();
	var $valorUnitario	= $('#valorUnitarioID').val();
	var $qtdeObri		= $('#qtdeObrigatorioID').val();
	var $indEletro		= $('#indEletronicaID').val();
	var $qtdeGerada		= $('#qtdeGeradaID').val();
	var $qtdeVendida	= $('#qtdeVendidaID').val();
	var $valorTotal		= $('#valorTotalID').val();
	var $valorPago		= $('#valorPagoID').val();
	var $valorReceber	= $('#valorReceberID').val();
	
	var vOK 			= validaRifaFinRec();
	//if (vOK	== false) return;
	
	$qtdeObri			= parseInt($qtdeObri);
	$qtdeVendida		= parseInt($qtdeVendida);
	
	$valorUnitario		= parseFloat($valorUnitario.replace(".", "").replace(",","."));
	$valorTotal			= parseFloat($qtdeVendida * $valorUnitario);
	$valorPago			= parseFloat($valorPago.replace(".", "").replace(",","."));
	$valorReceber		= parseFloat($valorTotal - $valorPago);

	if ($indEletro == 1){
		$('#divInfoQtdeGeradaID').addClass('hidden');
		$('#lbInfoTipoID').text('ELETRÔNICA');
		$('#lbInfoQtdeVendaID').text($qtdeGerada);
	}else{
		$('#divInfoQtdeGeradaID').removeClass('hidden');
		$('#lbInfoTipoID').text('PAPEL');
		$('#lbInfoQtdeVendaID').text($qtdeVendida);
		$('#lbInfoQtdeGeradaID').text($qtdeGerada);
	}
	
	$('#lbInfoFormandoID').text($formando);
	$('#lbInfoNomeID').text($nome);
	$('#lbInfoValorID').text($nome);
	$('#lbInfoQtdeObrigatorioID').text($qtdeObri);

	//Verificar se eletrônica
	
	
	// MASCARA MOEDA
	var options = {
		symbol : "",
		decimal : ",",
		thousand: ".",
		precision : 2,
		format: "%s%v"
	};
	
	$desc	= "<strong>&nbsp;<span class='text-success'>"+accounting.formatMoney($valorTotal, options)+"</span>&nbsp;</strong>";
	$('#lbInfoTotalID').html($desc);

	$valor		= accounting.formatMoney($nValor, options);
	$('#lbInfoValorID').text($valor);
	
	$desc	= "<strong>&nbsp;<span class='text-success'>"+accounting.formatMoney($valorPago, options)+"</span>&nbsp;</strong>";
	$('#lbInfoValorPagoID').html($desc);
	
	$('#divInfoDebitoID').removeClass('hidden');
	$('#lbInfoDebitoID').html("<strong>&nbsp;<span class='text-danger'>"+accounting.formatMoney($valorReceber, options)+"</span>&nbsp;</strong>");
	
	
	
}

/******************************************************
SUBMIT FORMULARIO
/******************************************************/
$('#rifaFinRecSubmitID').on("click", function(e) {
	
	var vOK 	= validaRifaFinRec();
	
	if(vOK == false) 	{
		$.gritter.add({
			title: 'Está faltando alguma coisa !!!',
			text: 'Corrija os campos marcados em vermelho',
			class_name: 'gritter-info gritter-error',
			time: '5000'
		});
		e.preventDefault();
		
		return false;
	}else{;
		$('#zgFormModalID').submit();
	}
});


$('#zgFormModalID').submit(function() {
	
	//Bloquear botão enquanto estiver salvando
	$('#rifaFinRecSubmitID').html('Aguarde...  <i class="ace-icon fa fa-spinner fa-spin orange bigger-125"></i>');
	$('#rifaFinRecSubmitID').attr("disabled","disabled");
	$('#rifaFinRecCancelID').attr("disabled","disabled");
	
	$.ajax({
		type:	"POST", 
		url:	"%DP_MODAL%",
		data:	$('#zgFormModalID').serialize(),
	}).done(function( data, textStatus, jqXHR) {
		if (checaRetornoOK(data) == true) {
			zgMostraMsg('rifaFinRecMsgID','Valor recebido com sucesso');
		}else{
			zgMostraErro('rifaFinRecMsgID',zgGetMsgRetorno(data));
		}

		//Desbloquear botão quando terminar de salvar
		$('#rifaFinRecSubmitID').html('<i class="fa fa-check bigger-110"></i> Valor Recebido !!!');
		//$('#rifaFinRecSubmitID').attr("disabled",false);
		$('#rifaFinRecCancelID').attr("disabled",false);

		$('#zgDivModalID').on('hidden.bs.modal', function () {
			zgLoadUrl('%URL_VOLTAR%');
			zgLimpaModal();
			$('#zgDivModalID').off('hidden.bs.modal');
		});

	}).fail(function( jqXHR, textStatus, errorThrown) {
		zgMostraErro('zgDivModalID',errorThrown);
	});
	return false; 
});


/******************************************************
VALIDA FORMULÁRIO
/******************************************************/
function validaRifaFinRec() {
	var vQtdeVendida		= $('#qtdeVendidaID').val();
	var vValorRecebido  	= $('#valorRecebidoID').val();
	var vCodForma			= $('#codFormaPagID').val();
	var vCodConta			= $('#codContaRecID').val();
	var vQtdeObri			= $('#qtdeObrigatorioID').val();
	var vQtdeGerada			= $('#qtdeGeradaID').val();
	var vMaxValor			= $('#valorReceberID').val();
	var vMaxValorFmt;
	
	
	vValorRecebido		= parseFloat(vValorRecebido.replace(".", "").replace(",","."));
	vMaxValor			= parseFloat(vMaxValor.replace(".", "").replace(",","."));
	vQtdeObri			= parseInt(vQtdeObri);
	vQtdeVendida		= parseInt(vQtdeVendida);
	vQtdeGerada			= parseInt(vQtdeGerada);

	var vOK				= true;
	
	// MASCARA MOEDA
	var options = {
		symbol : "R$ ",
		decimal : ",",
		thousand: ".",
		precision : 2,
		format: "%s%v"
	};
	
	vMaxValorFmt = accounting.formatMoney(vMaxValor, options);

	/** QUANTIDADE DE RIFAS **/
	if (!vQtdeVendida){
		$('#divQtdeVendidaID').addClass('has-error');
		$('#divHelpQtdePagarID').html(zgCriaSpanErro('A quantidade de rifas vendidas pelo formando deve ser preenchida!'));
		vOK		= false;
	}else if (vQtdeVendida < vQtdeObri){
		$('#divQtdeVendidaID').addClass('has-error');
		$('#divHelpQtdePagarID').html(zgCriaSpanErro('A quantidade de rifas vendidas não pode ser inferior a quantidade obrigatória de vendas ('+vQtdeObri+' bilhetes).'));
		vOK		= false;
	}else if (vQtdeVendida > vQtdeGerada){
		$('#divQtdeVendidaID').addClass('has-error');
		$('#divHelpQtdePagarID').html(zgCriaSpanErro('A quantidade de rifas vendidas não pode ser maior que quantidade gerada ('+vQtdeGerada+').'));
		vOK		= false;
	}else{
		$('#divQtdeVendidaID').removeClass('has-error');
		$('#divHelpQtdePagarID').html('&nbsp;');
	}
	
	/** VALOR A RECEBER **/
	if (!vValorRecebido){
		$('#divValorRecebidoID').addClass('has-error');
		$('#divHelpalorRecebidoID').html(zgCriaSpanErro('Preencha o valor recebido do formando!'));
		vOK		= false;
	}else if (vValorRecebido > vMaxValor){
		$('#divValorRecebidoID').addClass('has-error');
		$('#divHelpalorRecebidoID').html(zgCriaSpanErro('Valor a receber deve ser inferior ao débito do formando ('+vMaxValorFmt+')'));
		vOK		= false;
	}else{
		$('#divValorRecebidoID').removeClass('has-error');
		$('#divHelpalorRecebidoID').html('&nbsp;');		
	}
	
	/** FORMA DE PAGAMENTO **/
	if (!vCodForma){
		$('#divFormaPagID').addClass('has-error');
		$('#divHelpFormaPagID').html(zgCriaSpanErro('A forma de pagamento deve ser preenchida!'));
		vOK		= false;
	}else{
		$('#divFormaPagID').removeClass('has-error');
		$('#divHelpFormaPagID').html('&nbsp;');		
	}
	
	/** CONTA DE RECEBIMENTO **/
	if (!vCodConta){
		$('#divContaRecID').addClass('has-error');
		$('#divHelpContaRecID').html(zgCriaSpanErro('A conta de recebimento deve ser preenchida! Caso não exista nenhuma conta, deve-se cadastrar um conta no MENU Financeiro->cadastro->bancário'));
		vOK		= false;
	}else{
		$('#divContaRecID').removeClass('has-error');
		$('#divHelpContaRecID').html('&nbsp;');		
	}
	
	
	if (vOK == true) {
		return true ;
	}else{
		//Rolar pagina para o topo
		$('html, body').animate({scrollTop:0}, 'slow');
		return false;
	}
}


</script>

